var gameData = [
	{
		game: "AFK Arena",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "00:00"
	},
	{
		game: "Another Eden",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "15:00"
	},
	{
		game: "Arknights",
		server: "EN",
		timezone: "Etc/GMT+7",
		dailyReset: "04:00"
	},
	{
		game: "Ash Arms",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "05:00"
	},
	{
		game: "Astral Chronicles",
		server: "Global",
		timezone: "Asia/Singapore",
		dailyReset: "05:00"
	},
	{
		game: "Azur Lane",
		server: "English",
		timezone: "America/Los_Angeles",
		dailyReset: "00:00"
	},
	{
		game: "Boku no Hero Academia: Smash Rising",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "00:00"
	},
	{
		game: "Brown Dust",
		server: "Global & Europe",
		timezone: "Etc/UTC",
		dailyReset: "20:00"
	},
	{
		game: "CIRCLET PRINCESS",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "00:00"
	},
	{
		game: "Dengeki Bunko: Crossing Void",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "12:00"
	},
	{
		game: "Destiny Child",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "04:00"
	},
	{
		game: "DISSIDIA FINAL FANTASY OPERA OMNIA",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "08:00"
	},
	{
		game: "Dragalia Lost",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "07:00"
	},
	{
		game: "Dream Eater",
		server: "Taiwan",
		timezone: "Asia/Taipei",
		dailyReset: "00:00"
	},
	{
		game: "Elune",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "00:00"
	},
	{
		game: "Epic Seven",
		server: "Europe",
		timezone: "Europe/Paris",
		dailyReset: "05:00"
	},
	{
		game: "Epic Seven",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "10:00"
	},
	{
		game: "Epic Seven",
		server: "Korea",
		timezone: "Asia/Seoul",
		dailyReset: "03:00"
	},
	{
		game: "Fate/Grand Order",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "00:00"
	},
	{
		game: "Fate/Grand Order",
		server: "NA",
		timezone: "America/Los_Angeles",
		dailyReset: "21:00"
	},
	{
		game: "Final Gear",
		server: "CN",
		timezone: "Asia/Shanghai",
		dailyReset: "00:00"
	},
	{
		game: "Fire Emblem Heroes",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "07:00"
	},
	{
		game: "Girls' Frontline",
		server: "EN",
		timezone: "Etc/GMT-8",
		dailyReset: "00:00"
	},
	{
		game: "Granblue Fantasy",
		server: "JP & EN",
		timezone: "Asia/Tokyo",
		dailyReset: "05:00"
	},
	{
		game: "Honkai Impact 3rd",
		server: "Americas",
		timezone: "Etc/GMT+5",
		dailyReset: "04:00"
	},
	{
		game: "Honkai Impact 3rd",
		server: "Europe",
		timezone: "Etc/GMT-1",
		dailyReset: "04:00"
	},
	{
		game: "Idle Heroes",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "00:00"
	},
	{
		game: "King's Raid",
		server: "America",
		timezone: "America/New_York",
		dailyReset: "00:00"
	},
	{
		game: "Langrisser",
		server: "Global",
		timezone: "America/Regina",
		dailyReset: "00:00"
	},
	{
		game: "LAST CLOUDIA",
		server: "EN",
		timezone: "America/Los_Angeles",
		dailyReset: "05:00"
	},
	{
		game: "Looney Tunes World of Mayhem",
		server: "Global",
		timezone: "America/Los_Angeles",
		dailyReset: "18:00"
	},
	{
		game: "Magia Record",
		server: "NA",
		timezone: "America/Los_Angeles",
		dailyReset: "01:00"
	},
	{
		game: "Millennium War Aigis",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "04:00"
	},
	{
		game: "Oshiro Project:RE Castle Defense",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "05:00"
	},
	{
		game: "OVERHIT",
		server: "Global",
		timezone: "Asia/Seoul",
		dailyReset: "05:00"
	},
	{
		game: "Pokemon Masters",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "06:00"
	},
	{
		game: "Princess Connect! Re:Dive",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "05:00"
	},
	{
		game: "Revue Starlight Re LIVE",
		server: "JP & EN",
		timezone: "Asia/Tokyo",
		dailyReset: "05:00"
	},
	{
		game: "Saint Seiya: Awakening",
		server: "Global",
		timezone: "Etc/GMT+4",
		dailyReset: "05:00"
	},
	{
		game: "Saint Seiya: Awakening",
		server: "SEA",
		timezone: "Asia/Jakarta",
		dailyReset: "05:00"
	},
	{
		game: "Sdorica",
		server: "Global",
		timezone: "Etc/UTC",
		dailyReset: "21:00"
	},
	{
		game: "SHIN MEGAMI TENSEI Liberation Dx2",
		server: "EN",
		timezone: "America/Los_Angeles",
		dailyReset: "18:00"
	},
	{
		game: "The Seven Deadly Sins: Hikari to Yami no Grand Cross",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "00:00"
	},
	{
		game: "Tokyo Afterschool Summoners",
		server: "Global",
		timezone: "Asia/Tokyo",
		dailyReset: "00:00"
	},
	{
		game: "Tokyo NECRO: SUICIDE MISSION",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "04:00"
	},
	{
		game: "Toram Online",
		server: "Global",
		timezone: "Asia/Tokyo",
		dailyReset: "05:00"
	},
	{
		game: "UNITIA: Shintaku no Shito x Shuuen no Megami",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "06:00"
	},
	{
		game: "Valkyrie Anatomia: The Origin",
		server: "Global",
		timezone: "Brazil/West",
		dailyReset: "11:00"
	},
	{
		game: "World Flipper",
		server: "JP",
		timezone: "Asia/Tokyo",
		dailyReset: "05:00"
	}
];

// Initialise list of filtered/hidden games using gameData.
var gameFilter = [];

for (let i = 0; i < gameData.length; i++) {
	gameFilter.push(
		{
			game: gameData[i].game,
			server: gameData[i].server,
			shown: "true"
		}
	);
}

// Check saved settings.
var timeFormat = "HH:mm";

if (localStorage.getItem('12HrTimeSwitch') == "true") {
	timeFormat = "h:mm A";

	document.getElementById("12HrTimeSwitch").checked = true;
}
if (localStorage.getItem('darkThemeSwitch') == "true") {
	document.body.classList.add("dark");
	document.getElementById("darkThemeSwitch").checked = true;
}

// Hide game containers.
if (localStorage.getItem('gameFilterList') != null) {
	var gameFilterSaved = getLocalStorageObject('gameFilterList');

	for (let i = 0; i < gameFilterSaved.length; i++) {
		if (gameFilterSaved[i].shown == "false") {
			var serverCount = 0, 
			skippedParent = false, 
			containerPosition = 0;

			for (let y = 1; y < document.getElementById("gameFilterSettings").childElementCount; y+=2, containerPosition++) {
				var gameLabel = document.getElementById("gameFilterSettings").children[y], 
				gameName = gameData[containerPosition].game;

				if (gameLabel.className.includes("gameParent")) {
					skippedParent = true;

					for (let x = 0; x < gameFilter.length; x++) {
						if (gameFilter[x].game == gameData[containerPosition].game) {
							serverCount++;
						}
					}
				} else if (gameFilterSaved[i].game == gameName) {
					gameLabel.previousElementSibling.checked = false;
					toggleGameServerHide(document.getElementsByClassName("gameServerToggle")[containerPosition]);
				}

				// Look at next div for the children.
				if (skippedParent) {
					y++;
					for (let z = 0; z < serverCount; z++, containerPosition++) {
						var childInput = document.getElementById("gameFilterSettings").children[y].getElementsByTagName("input")[z];

						// Compare current child with server in saved filter to see if there's a match.
						if (gameFilterSaved[i].game == gameFilter[containerPosition].game && gameFilterSaved[i].server == gameFilter[containerPosition].server) {
							childInput.checked = false;
							toggleGameServerHide(document.getElementsByClassName("gameServerToggle")[containerPosition], true);
						}
					}
					containerPosition--;
					skippedParent = false;
					serverCount = 0;
				}
			}
		}
	}
}

// Show local time data.
var now = moment(), 
nowZone = moment.tz.guess();
document.getElementById("currentLocalTime").textContent = now.format(timeFormat);
document.getElementById("currentLocalDate").textContent = now.format("dddd, Do MMMM, YYYY");
document.getElementById("currentLocalTimezone").textContent = nowZone + " — " + now.format("[GMT ]Z");

// Convert game times to local time zone and store results.
var gameDataConverted = [];
for (let i = 0; i < gameData.length; i++) {
	var gameTimezone = gameData[i].timezone, 
	currentServerTime = now.clone().tz(gameTimezone);
	gameData[i].dailyReset = moment.tz(gameData[i].dailyReset, "HH:mm", gameTimezone);

	// Convert to local.
	var localResetTime = gameData[i].dailyReset.clone().tz(nowZone);

	// Change local reset time to tomorrow if it has already passed.
	var todayResetPassed = (now.preciseDiff(localResetTime, true)).firstDateWasLater;
	if (todayResetPassed) {
		if (gameData[i].dailyReset.hours() == 0) {
			// Add 48 hours to fix midnight reset using previous day.
			localResetTime.add(48, "h");
		} else {
			localResetTime.add(24, "h");
		}
	}

	// Calculate time left until daily reset.
	var timeRemaining = now.preciseDiff(localResetTime, true);
	timeRemaining = timeRemaining.hours + " hours " + timeRemaining.minutes + " minutes";

	// Store.
	gameDataConverted.push(
		{
			dailyReset: localResetTime,
			serverTime: currentServerTime,
			timeToReset: timeRemaining
		}
	);
}

// Loop print the results as divs into #resultsContainer.
for (let i = 0; i < gameData.length; i++) {
	var gameCont = document.getElementById("resultsContainer").getElementsByClassName("gameContainer")[i], 
	gameHead = gameCont.getElementsByClassName("gameHeader")[0], 
	gameBody = gameCont.getElementsByClassName("gameTimes")[0];

	gameHead.insertAdjacentHTML("beforeend", "<h4>" + gameData[i].server + "</h4>");
	gameBody.getElementsByTagName("p")[0].insertAdjacentHTML("afterend", "<p>" + gameDataConverted[i].dailyReset.format(timeFormat) + "</p>");
	gameBody.getElementsByTagName("p")[2].insertAdjacentHTML("afterend", "<p>" + gameDataConverted[i].timeToReset + "</p>");
	// Add prefix for timezone abbreviation if it's an offset.
	if (gameDataConverted[i].serverTime.format("z").includes("-") || gameDataConverted[i].serverTime.format("z").includes("+")) {
		gameBody.getElementsByTagName("p")[4].insertAdjacentHTML("afterend", "<p>" + gameData[i].dailyReset.format(timeFormat) + " UTC" + gameDataConverted[i].serverTime.format("Z") + "</p>");
		gameBody.getElementsByTagName("p")[6].insertAdjacentHTML("afterend", "<p>" + gameDataConverted[i].serverTime.format(timeFormat) + " UTC" + gameDataConverted[i].serverTime.format("Z") + "</p>");
	} else {
		gameBody.getElementsByTagName("p")[4].insertAdjacentHTML("afterend", "<p>" + gameData[i].dailyReset.format(timeFormat + " z") + "</p>");
		gameBody.getElementsByTagName("p")[6].insertAdjacentHTML("afterend", "<p>" + gameDataConverted[i].serverTime.format(timeFormat + " z") + "</p>");
	}
}

// Refresh time values every minute.
setInterval(timeCalc, 60000);

function timeCalc() {
	// Refresh time.
	now = moment();

	// Refresh converted times.
	for (let i = 0; i < gameData.length; i++) {
		var gameTimezone = gameData[i].timezone, 
		currentServerTime = now.clone().tz(gameTimezone);

		// Convert to local.
		var localResetTime = gameData[i].dailyReset.clone().tz(nowZone);

		// Change local reset time to tomorrow if it has already passed.
		var todayResetPassed = (now.preciseDiff(localResetTime, true)).firstDateWasLater;
		if (todayResetPassed) {
			if (gameData[i].dailyReset.hours() == 0) {
				// Add 48 hours to fix midnight reset using previous day.
				localResetTime.add(48, "h");
			} else {
				localResetTime.add(24, "h");
			}
		}

		// Calculate time left until daily reset.
		var timeRemaining = now.preciseDiff(localResetTime, true);
		timeRemaining = timeRemaining.hours + " hours " + timeRemaining.minutes + " minutes";

		// Replace converted times.
		gameDataConverted[i].dailyReset = localResetTime;
		gameDataConverted[i].serverTime = currentServerTime;
		gameDataConverted[i].timeToReset = timeRemaining;
	}

	// Print refreshed values.
	document.getElementById("currentLocalTime").textContent = now.format(timeFormat);
	document.getElementById("currentLocalDate").textContent = now.format("dddd, Do MMMM, YYYY");
	for (let i = 0; i < gameData.length; i++) {
		var gameCont = document.getElementById("resultsContainer").getElementsByClassName("gameContainer")[i], 
		gameBody = gameCont.getElementsByClassName("gameTimes")[0];

		gameBody.getElementsByTagName("p")[1].textContent = gameDataConverted[i].dailyReset.format(timeFormat);
		gameBody.getElementsByTagName("p")[3].textContent = gameDataConverted[i].timeToReset;
		// Add prefix for timezone abbreviation if it's an offset.
		if (gameDataConverted[i].serverTime.format("z").includes("-") || gameDataConverted[i].serverTime.format("z").includes("+")) {
			gameBody.getElementsByTagName("p")[5].textContent = gameData[i].dailyReset.format(timeFormat) + " UTC" + gameDataConverted[i].serverTime.format("Z");
			gameBody.getElementsByTagName("p")[7].textContent = gameDataConverted[i].serverTime.format(timeFormat) + " UTC" + gameDataConverted[i].serverTime.format("Z");
		} else {
			gameBody.getElementsByTagName("p")[5].textContent = gameData[i].dailyReset.format(timeFormat + " z");
			gameBody.getElementsByTagName("p")[7].textContent = gameDataConverted[i].serverTime.format(timeFormat + " z");
		}
	}
}

function toggleMenu() {
	var menuButton = document.getElementById("mainMenuButt");

	if (document.getElementById("menu").style.marginLeft == "0px") {
		// Close.
		document.getElementById("menu").removeAttribute("style");

		menuButton.textContent = "☰";

		document.getElementById("outsideMenu").removeAttribute("style");
	} else {
		// Open.
		document.getElementById("menu").style.marginLeft = "0px";

		menuButton.textContent = "✖";

		document.getElementById("outsideMenu").style.width = "100%";
		document.getElementById("outsideMenu").style.height = "100%";
	}
}

function searchFilter () {
	// Convert search term to uppercase and remove accent marks.
	var searchTerm = document.getElementById("filterSearchBox").value.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();

	for (let i = 0; i < gameData.length; i++) {
		// Find game name for each container, convert to uppercase, and remove accent marks.
		var gameCont = document.getElementById("resultsContainer").getElementsByClassName("gameContainer")[i], 
		gameHead = gameCont.getElementsByClassName("gameHeader")[0], 
		gameName = gameHead.getElementsByTagName("h3")[0].textContent.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();

		if (!gameName.includes(searchTerm)) {
			// Hide.
			gameCont.style.display = "none";
		} else {
			// Show, if game isn't filtered.
			if (gameFilter[i].shown == "true") {
				gameCont.removeAttribute("style");
			}
		}
	}
}

function settingToggle(setting) {
	var settingId = setting.id;
	localStorage.setItem([settingId], setting.checked);

	if (settingId == "12HrTimeSwitch") {
		if (setting.checked) {
			timeFormat = "h:mm A";
		} else {
			timeFormat = "HH:mm";
		}
		timeCalc();
	} else if (settingId == "darkThemeSwitch") {
		if (setting.checked) {
			document.body.classList.add("dark");
		} else {
			document.body.classList.remove("dark");
		}
	}
}

function showSearch(button) {
	var searchBox = document.getElementById("filterSearchBox");

	button.style.display = "none";
	document.getElementsByTagName("header")[0].getElementsByTagName("h1")[0].style.display = "none";
	searchBox.style.display = "block";
	searchBox.style.width = null;
	searchBox.focus();
}

function searchHide(searchBox) {
	var searchButton = document.getElementById("filterSearchOpen");

	if (searchButton.style.display == "none") {
		searchBox.style.width = 0;
		// Wait for animation before changing display.
		setTimeout(
			function () {
				document.getElementsByTagName("header")[0].getElementsByTagName("h1")[0].removeAttribute("style");
				searchBox.removeAttribute("style");
				searchButton.style.display = null;
			},
			200
		);
	}
}

function getLocalStorageObject(ObjectName) {
	var parsedObject = JSON.parse(localStorage.getItem(ObjectName));

	return parsedObject;
}

// Store the original height of the games section in menu, for later usage when hiding/showing.
var gamesMenuSectionHeight = document.getElementById("gameFilterSettings").offsetHeight + "px";
// Set the section height to a value (instead of auto) to enable initial transistion animation.
document.getElementById("gameFilterSettings").style.height = gamesMenuSectionHeight;

function gamesMenuSectionToggle(dropArrow) {
	var menuSection = dropArrow.parentElement;

	if (menuSection.style.height == "36px") {
		// Open.
		dropArrow.removeAttribute("style");
		menuSection.style.height = gamesMenuSectionHeight;
	} else {
		// Close.
		dropArrow.style.transform = "rotate(45deg)";
		dropArrow.style.top = "-15px";
		menuSection.style.height = "36px";
	}
}

function menuChildrenToggle(dropArrow) {
	var gameChild = dropArrow.parentElement.nextElementSibling;

	if (gameChild.style.height == (gameChild.childElementCount * 20.5) + "px") {
		// Close.
		dropArrow.removeAttribute("style");
		gameChild.removeAttribute("style");
	} else {
		// Open.
		dropArrow.style.transform = "rotate(225deg)";
		dropArrow.style.top = "10px";
		gameChild.style.height = (gameChild.childElementCount * 20.5) + "px";
	}
}

function toggleGameServerHide(toggle, child) {
	// Find the server's position in gameData.
	for (var position = 0; position < gameData.length; position++) {
		if (document.getElementsByClassName("gameServerToggle")[position] == toggle) {
			break;
		}
	}

	if (gameFilter[position].shown == "true") {
		// Hide.
		gameFilter[position].shown = "false";
		document.getElementById("resultsContainer").getElementsByClassName("gameContainer")[position].style.display = "none";

		// Check if other children are hidden.
		if (child == true) {
			var parent = toggle.parentElement.previousElementSibling.previousElementSibling, 
			gameName = gameData[position].game, 
			allHidden = true;

			for (let i = 0; i < gameFilter.length; i++) {
				if (gameFilter[i].game == gameName) {
					if (gameFilter[i].shown == "true") {
						allHidden = false;
					}
				}
			}
			if (allHidden == true) {
				parent.checked = false;
				parent.indeterminate = false;
			} else {
				parent.checked = true;
				parent.indeterminate = true;
			}
		}
	} else {
		// Show.
		gameFilter[position].shown = "true";
		document.getElementById("resultsContainer").getElementsByClassName("gameContainer")[position].removeAttribute("style");

		// Check if other children are shown.
		if (child == true) {
			var parent = toggle.parentElement.previousElementSibling.previousElementSibling, 
			gameName = gameData[position].game, 
			allShown = true;

			for (let i = 0; i < gameFilter.length; i++) {
				if (gameFilter[i].game == gameName) {
					if (gameFilter[i].shown == "false") {
						allShown = false;
					}
				}
			}
			if (allShown == true) {
				parent.checked = true;
				parent.indeterminate = false;
			} else {
				parent.checked = true;
				parent.indeterminate = true;
			}
		}
	}
	// Store.
	localStorage.setItem("gameFilterList", JSON.stringify(gameFilter));
}

function toggleGameParentHide(gameSwitch) {
	var gameName = gameSwitch.nextElementSibling.textContent.trim(), 
	parentSwitchStatus = gameSwitch.checked, 
	childrenHolder = gameSwitch.nextElementSibling.nextElementSibling, 
	serverCount = 0;

	if (parentSwitchStatus == false) {
		// Hide servers.
		for (let i = 0; i < gameFilter.length; i++) {
			if (gameFilter[i].game == gameName) {
				serverCount++;

				gameFilter[i].shown = "false";
				document.getElementById("resultsContainer").getElementsByClassName("gameContainer")[i].style.display = "none";
			}
		}
		// Toggle switch off.
		for (let i = 0; i < serverCount; i++) {
			childrenHolder.getElementsByTagName("input")[i].checked = false;
		}
		gameSwitch.checked = false;
		gameSwitch.indeterminate = false;
	} else {
		// Show servers.
		for (let i = 0; i < gameFilter.length; i++) {
			if (gameFilter[i].game == gameName) {
				serverCount++;

				gameFilter[i].shown = "true";
				document.getElementById("resultsContainer").getElementsByClassName("gameContainer")[i].removeAttribute("style");
			}
		}
		// Toggle switch on.
		for (let i = 0; i < serverCount; i++) {
			childrenHolder.getElementsByTagName("input")[i].checked = true;
		}
		gameSwitch.checked = true;
	}
	// Store.
	localStorage.setItem("gameFilterList", JSON.stringify(gameFilter));
}
